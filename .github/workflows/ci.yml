on: [push]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - uses: erlef/setup-beam@a6e26b22319003294c58386b6f25edbc7336819a # v1.18.0
      with:
        otp-version: 27.3.3
        rebar3-version: 3.24.0

    - name: Run Linter ğŸ§
      shell: bash
      run: make lint

    - name: Configure git ğŸ”§
      run: |
        git config --global url."https://${{ secrets.KIVRABOT }}@github.com/kivra/".insteadOf "git@github.com:kivra/"
        git config --global url."https://${{ secrets.KIVRABOT }}@github.com/kivra".insteadOf "https://github.com/kivra"

    - name: Run Erlang Tests ğŸƒğŸ¾
      shell: bash
      run: make test-erl

    - name: Run Go Tests ğŸƒğŸ½â€â™€ï¸
      shell: bash
      run: make test-go

    - name: Run python Tests ğŸƒğŸ¾
      shell: bash
      run: make test-python

  release:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'no-release:') == false
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Bump version and push tag
      id: tag_version
      uses: kivra/github-tag-action@fcfbdceb3093f6d85a3b194740f8c6cec632f4e2 # v6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create a GitHub release
      uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_version.outputs.new_tag }}
        release_name: Release ${{ steps.tag_version.outputs.new_tag }}
        body: ${{ steps.tag_version.outputs.changelog }}
